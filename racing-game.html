<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Racer - SeedFrames Engine</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            text-align: center;
        }
        
        .game-container {
            border: 3px solid #e74c3c;
            border-radius: 10px;
            margin: 20px auto;
            display: inline-block;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.5);
        }
        
        .game-info {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin: 20px auto;
            max-width: 800px;
        }
        
        .controls {
            background: rgba(231, 76, 60, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 10px 0;
        }
        
        .stat {
            background: rgba(52, 73, 94, 0.5);
            padding: 10px;
            border-radius: 5px;
            min-width: 120px;
        }
        
        h1 {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
            color: #e74c3c;
        }
        
        .track-selector {
            background: rgba(52, 152, 219, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .lap-info {
            background: rgba(46, 204, 113, 0.3);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 2px solid #2ecc71;
        }
        
        .timer {
            font-size: 24px;
            font-weight: bold;
            color: #f39c12;
        }
    </style>
</head>
<body>
    <h1>üèéÔ∏è Speed Racer</h1>
    
    <div class="game-info">
        <div class="track-selector">
            <strong>Track: <span id="current-track">Circuit 1</span></strong>
            <button onclick="changeTrack(1)">Circuit 1</button>
            <button onclick="changeTrack(2)">Circuit 2</button>
            <button onclick="changeTrack(3)">Speedway</button>
        </div>
        
        <div class="lap-info">
            <strong>Lap: <span id="current-lap">1</span> / <span id="total-laps">3</span></strong>
            <div class="timer" id="lap-timer">00:00.000</div>
        </div>
        
        <div class="stats">
            <div class="stat">
                <strong>Speed:</strong><br>
                <span id="speed">0</span> km/h
            </div>
            <div class="stat">
                <strong>Best Lap:</strong><br>
                <span id="best-lap">--:--.---</span>
            </div>
            <div class="stat">
                <strong>Position:</strong><br>
                <span id="position">1st</span>
            </div>
            <div class="stat">
                <strong>Drift Score:</strong><br>
                <span id="drift-score">0</span>
            </div>
        </div>
        
        <div class="game-info" style="margin-top: 20px;">
            <div class="controls">
                <strong>Racing Controls:</strong><br>
                <strong>W/‚Üë</strong> Accelerate | <strong>S/‚Üì</strong> Brake<br>
                <strong>A/‚Üê</strong> Turn Left | <strong>D/‚Üí</strong> Turn Right<br>
                <strong>R</strong> Reset Position
            </div>
        </div>
        
        <div class="controls">
            <strong>Controls:</strong><br>
            <strong>WASD</strong> or <strong>Arrow Keys</strong> to drive<br>
            <strong>Space</strong> to brake/handbrake<br>
            <strong>Shift</strong> to boost<br>
            <strong>R</strong> to reset car
        </div>
    </div>
    
    <div class="game-container" id="game-container"></div>
    
    <script src="./src/seedframes.js"></script>
    <script>
        let engine, scene, player;
        let gameState = {
            currentTrack: 1,
            currentLap: 1,
            totalLaps: 3,
            lapTime: 0,
            bestLapTime: Infinity,
            driftScore: 0,
            boostAvailable: true,
            checkpoints: []
        };
        
        let aiCars = [];
        let trackBoundaries = [];
        let checkpoints = [];
        let lapStartTime = 0;
        
        // Track designs
        const tracks = [
            // Circuit 1 - Simple oval
            {
                name: "Circuit 1",
                boundaries: [
                    {x: 100, y: 100, width: 1000, height: 50}, // Top
                    {x: 100, y: 450, width: 1000, height: 50}, // Bottom
                    {x: 100, y: 100, width: 50, height: 400},  // Left
                    {x: 1050, y: 100, width: 50, height: 400}  // Right
                ],
                checkpoints: [
                    {x: 600, y: 100, width: 20, height: 50},
                    {x: 600, y: 450, width: 20, height: 50}
                ],
                startPosition: {x: 150, y: 250},
                aiCars: 2
            },
            // Circuit 2 - Figure 8
            {
                name: "Circuit 2",
                boundaries: [
                    {x: 50, y: 50, width: 500, height: 40},   // Top left
                    {x: 650, y: 50, width: 500, height: 40},  // Top right
                    {x: 50, y: 510, width: 500, height: 40},  // Bottom left
                    {x: 650, y: 510, width: 500, height: 40}, // Bottom right
                    {x: 550, y: 200, width: 40, height: 200}, // Center vertical
                    {x: 200, y: 250, width: 200, height: 40}  // Center horizontal
                ],
                checkpoints: [
                    {x: 300, y: 50, width: 20, height: 40},
                    {x: 800, y: 50, width: 20, height: 40},
                    {x: 300, y: 510, width: 20, height: 40},
                    {x: 800, y: 510, width: 20, height: 40}
                ],
                startPosition: {x: 100, y: 100},
                aiCars: 3
            },
            // Speedway - High speed straight
            {
                name: "Speedway",
                boundaries: [
                    {x: 50, y: 100, width: 1100, height: 40},  // Top
                    {x: 50, y: 460, width: 1100, height: 40}, // Bottom
                    {x: 50, y: 100, width: 40, height: 400},  // Left
                    {x: 1110, y: 100, width: 40, height: 400} // Right
                ],
                checkpoints: [
                    {x: 300, y: 100, width: 20, height: 40},
                    {x: 600, y: 100, width: 20, height: 40},
                    {x: 900, y: 100, width: 20, height: 40}
                ],
                startPosition: {x: 100, y: 250},
                aiCars: 1
            }
        ];
        
        function initGame() {
            try {
                // Check if engine is available
                if (typeof GameEngine === 'undefined') {
                    throw new Error('GameEngine not loaded. Please check if seedframes.js is properly loaded.');
                }
                
                if (typeof GameEngine.SeedFrames === 'undefined') {
                    throw new Error('SeedFrames class not available in GameEngine.');
                }
                
                engine = new GameEngine.SeedFrames({
                    width: 1200,
                    height: 600,
                    containerId: 'game-container',
                    backgroundColor: '#2c3e50',
                    debug: false
                });
                
                scene = engine.createScene('RacingTrack');
                engine.sceneManager.add('main', scene);
                
                // Setup physics
                engine.physicsEngine.setCollisionRule('Player', 'TrackBoundary', true);
                engine.physicsEngine.setCollisionRule('Player', 'Checkpoint', true);
                engine.physicsEngine.setCollisionRule('Player', 'AICar', true);
                engine.physicsEngine.setCollisionRule('AICar', 'TrackBoundary', true);
                engine.physicsEngine.setCollisionRule('AICar', 'Checkpoint', true);
                
                loadTrack(gameState.currentTrack);
                
                engine.start();
                console.log('Speed Racer started!');
                
            } catch (error) {
                console.error('Failed to initialize game:', error);
                // Show error to user
                const container = document.getElementById('game-container');
                if (container) {
                    container.innerHTML = `
                        <div style="color: white; padding: 20px; text-align: center;">
                            <h3>‚ùå Game Initialization Failed</h3>
                            <p>${error.message}</p>
                            <p>Please check the console for more details.</p>
                            <button onclick="location.reload()" style="padding: 10px 20px; margin: 10px;">Retry</button>
                        </div>
                    `;
                }
            }
        }
        
        function loadTrack(trackIndex) {
            if (trackIndex < 1 || trackIndex > tracks.length) return;
            
            // Clear previous track
            clearTrack();
            
            const track = tracks[trackIndex - 1];
            gameState.currentTrack = trackIndex;
            gameState.currentLap = 1;
            gameState.lapTime = 0;
            lapStartTime = Date.now();
            
            // Create track boundaries
            track.boundaries.forEach((boundaryData, index) => {
                const boundary = scene.createGameObject(`Boundary${index}`)
                    .at(boundaryData.x + boundaryData.width/2, boundaryData.y + boundaryData.height/2)
                    .withColor('#8B4513', boundaryData.width, boundaryData.height)
                    .withCollider('box', boundaryData.width, boundaryData.height, false, 'TrackBoundary')
                    .build();
                trackBoundaries.push(boundary);
            });
            
            // Create checkpoints
            track.checkpoints.forEach((checkpointData, index) => {
                const checkpoint = scene.createGameObject(`Checkpoint${index}`)
                    .at(checkpointData.x + checkpointData.width/2, checkpointData.y + checkpointData.height/2)
                    .withColor('#00FF00', checkpointData.width, checkpointData.height)
                    .withCollider('box', checkpointData.width, checkpointData.height, true, 'Checkpoint')
                    .build();
                
                checkpoint.addComponent(new CheckpointComponent(index));
                checkpoints.push(checkpoint);
            });
            
            // Create player car
            player = scene.createGameObject('PlayerCar')
                .at(track.startPosition.x, track.startPosition.y)
                .withColor('#e74c3c', 40, 20)
                .withCollider('box', 40, 20, false, 'Player')
                .withRacingPlayer({
                    speed: 300,
                    acceleration: 800,
                    maxSpeed: 400,
                    handling: 180,
                    driftFactor: 0.8
                })
                .build();
            
            // Add racing components
            const racingComponent = player.getComponent(GameEngine.RacingPlayer);
            if (racingComponent && typeof racingComponent.onDrift !== 'undefined') {
                racingComponent.onDrift = (driftIntensity) => {
                    gameState.driftScore += Math.floor(driftIntensity * 10);
                    updateUI();
                };
            }
            
            // Create AI cars
            for (let i = 0; i < track.aiCars; i++) {
                createAICar(i, track);
            }
            
            // Setup camera
            scene.camera.follow(player);
            
            updateUI();
        }
        
        function createAICar(index, track) {
            const aiCar = scene.createGameObject(`AICar${index}`)
                .at(track.startPosition.x + (index + 1) * 60, track.startPosition.y)
                .withColor('#3498db', 40, 20)
                .withCollider('box', 40, 20, false, 'AICar')
                .build();
            
            // Add AI driving component
            aiCar.addComponent(new AIDrivingComponent(track, index));
            aiCars.push(aiCar);
        }
        
        function clearTrack() {
            // Remove all track objects
            if (scene) {
                const objectsToRemove = [...scene.gameObjects];
                objectsToRemove.forEach(obj => {
                    if (obj.name !== 'Scene') {
                        scene.removeGameObject(obj);
                    }
                });
            }
            
            trackBoundaries = [];
            checkpoints = [];
            aiCars = [];
        }
        
        function changeTrack(trackIndex) {
            loadTrack(trackIndex);
        }
        
        function updateUI() {
            document.getElementById('current-track').textContent = tracks[gameState.currentTrack - 1].name;
            document.getElementById('current-lap').textContent = gameState.currentLap;
            document.getElementById('total-laps').textContent = gameState.totalLaps;
            document.getElementById('drift-score').textContent = gameState.driftScore;
            
            // Update speed
            if (player) {
                const racingComponent = player.getComponent(GameEngine.RacingPlayer);
                if (racingComponent && typeof racingComponent.getSpeed === 'function') {
                    const speed = Math.round(racingComponent.getSpeed() * 3.6); // Convert to km/h
                    document.getElementById('speed').textContent = speed;
                } else {
                    document.getElementById('speed').textContent = '0';
                }
            }
            
            // Update best lap time
            if (gameState.bestLapTime !== Infinity) {
                document.getElementById('best-lap').textContent = formatTime(gameState.bestLapTime);
            }
        }
        
        function formatTime(timeMs) {
            const totalSeconds = Math.floor(timeMs / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const milliseconds = Math.floor((timeMs % 1000) / 10);
            
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(3, '0')}`;
        }
        
        function updateLapTimer() {
            const currentTime = Date.now();
            gameState.lapTime = currentTime - lapStartTime;
            
            document.getElementById('lap-timer').textContent = formatTime(gameState.lapTime);
        }
        
        function completeLap() {
            const lapTime = gameState.lapTime;
            
            // Check if it's a new best lap
            if (lapTime < gameState.bestLapTime) {
                gameState.bestLapTime = lapTime;
                console.log('New best lap time!');
            }
            
            gameState.currentLap++;
            
            if (gameState.currentLap > gameState.totalLaps) {
                // Race completed
                showRaceComplete();
            } else {
                // Start next lap
                lapStartTime = Date.now();
                console.log(`Lap ${gameState.currentLap} started!`);
            }
            
            updateUI();
        }
        
        function showRaceComplete() {
            const totalTime = Date.now() - (lapStartTime - gameState.lapTime);
            const finalTime = formatTime(totalTime);
            
            alert(`Race completed!\nTotal time: ${finalTime}\nBest lap: ${formatTime(gameState.bestLapTime)}\nDrift score: ${gameState.driftScore}`);
            
            // Reset race
            loadTrack(gameState.currentTrack);
        }
        
        // Custom Components
        class CheckpointComponent extends GameEngine.Component {
            constructor(checkpointIndex) {
                super();
                this.checkpointIndex = checkpointIndex;
                this.activated = false;
            }
            
            onCollisionEnter(other) {
                if (other.name === 'PlayerCar' && !this.activated) {
                    this.activated = true;
                    console.log(`Checkpoint ${this.checkpointIndex} reached!`);
                    
                    // Check if lap is complete
                    if (this.checkpointIndex === 0 && gameState.currentLap > 1) {
                        completeLap();
                    }
                }
            }
        }
        
        class AIDrivingComponent extends GameEngine.Component {
            constructor(track, carIndex) {
                super();
                this.track = track;
                this.carIndex = carIndex;
                this.currentCheckpoint = 0;
                this.speed = 200 + (carIndex * 20);
                this.acceleration = 600;
                this.maxSpeed = 300 + (carIndex * 30);
                this.handling = 150;
                this.targetPosition = new GameEngine.Vector2(0, 0);
                this.updateTarget();
            }
            
            update(deltaTime) {
                if (!this.gameObject) return;
                
                // Simple AI: move towards next checkpoint
                const direction = this.targetPosition.subtract(this.gameObject.transform.position);
                const distance = direction.magnitude();
                
                if (distance < 50) {
                    // Reached checkpoint, move to next
                    this.currentCheckpoint = (this.currentCheckpoint + 1) % this.track.checkpoints.length;
                    this.updateTarget();
                }
                
                if (distance > 10) {
                    // Move towards target
                    const normalizedDirection = direction.normalize();
                    const targetSpeed = Math.min(this.speed, this.maxSpeed);
                    
                    // Simple movement without Rigidbody
                    const moveSpeed = targetSpeed * deltaTime;
                    this.gameObject.transform.position.x += normalizedDirection.x * moveSpeed;
                    this.gameObject.transform.position.y += normalizedDirection.y * moveSpeed;
                    
                    // Rotate towards target
                    const targetAngle = Math.atan2(normalizedDirection.y, normalizedDirection.x);
                    this.gameObject.transform.rotation = targetAngle;
                }
            }
            
            updateTarget() {
                if (this.track.checkpoints[this.currentCheckpoint]) {
                    const checkpoint = this.track.checkpoints[this.currentCheckpoint];
                    this.targetPosition = new GameEngine.Vector2(
                        checkpoint.x + checkpoint.width/2,
                        checkpoint.y + checkpoint.height/2
                    );
                }
            }
        }
        
        // Input handling
        document.addEventListener('keydown', (e) => {
            if (!player) return;
            
            const racingComponent = player.getComponent(GameEngine.RacingPlayer);
            if (!racingComponent) return;
            
            switch(e.code) {
                case 'KeyW':
                case 'ArrowUp':
                    racingComponent.accelerate(1.0);
                    break;
                case 'KeyS':
                case 'ArrowDown':
                    racingComponent.brake(1.0);
                    break;
                case 'KeyA':
                case 'ArrowLeft':
                    racingComponent.steer(-1.0);
                    break;
                case 'KeyD':
                case 'ArrowRight':
                    racingComponent.steer(1.0);
                    break;
                case 'KeyR':
                    // Reset car position
                    const track = tracks[gameState.currentTrack - 1];
                    player.transform.position.x = track.startPosition.x;
                    player.transform.position.y = track.startPosition.y;
                    player.transform.rotation = 0;
                    
                    // Reset racing component if available
                    if (typeof racingComponent.setVelocity === 'function') {
                        racingComponent.setVelocity(new GameEngine.Vector2(0, 0));
                    }
                    break;
            }
        });
        
        // Handle key release
        document.addEventListener('keyup', (e) => {
            if (!player) return;
            
            const racingComponent = player.getComponent(GameEngine.RacingPlayer);
            if (!racingComponent) return;
            
            switch(e.code) {
                case 'KeyW':
                case 'ArrowUp':
                case 'KeyS':
                case 'ArrowDown':
                    racingComponent.targetSpeed = 0;
                    break;
                case 'KeyA':
                case 'ArrowLeft':
                case 'KeyD':
                case 'ArrowRight':
                    racingComponent.steeringAngle = 0;
                    break;
            }
        });
        
        // Game loop for timer updates
        function gameLoop() {
            updateLapTimer();
            
            // Update racing components
            if (player) {
                const racingComponent = player.getComponent(GameEngine.RacingPlayer);
                if (racingComponent && typeof racingComponent.update === 'function') {
                    racingComponent.update(0.016); // Assuming 60 FPS
                }
            }
            
            // Update AI cars
            aiCars.forEach(aiCar => {
                const aiComponent = aiCar.getComponent(AIDrivingComponent);
                if (aiComponent && typeof aiComponent.update === 'function') {
                    aiComponent.update(0.016);
                }
            });
            
            requestAnimationFrame(gameLoop);
        }
        
        // Initialize game when page loads
        window.addEventListener('load', () => {
            console.log('Speed Racer loading...');
            // Wait for engine to be ready
            const checkEngine = () => {
                if (typeof GameEngine !== 'undefined' && GameEngine.SeedFrames) {
                    console.log('Engine ready, initializing game...');
                    initGame();
                    gameLoop();
                } else {
                    console.log('Engine not ready yet, waiting...');
                    setTimeout(checkEngine, 100);
                }
            };
            checkEngine();
        });
    </script>
</body>
</html>